<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.qingfeng.cms.biz.sign.dao.ActiveSignDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.qingfeng.cms.domain.sign.entity.ActiveSignEntity" id="activeSignMap">
        <result property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="applyId" column="apply_id"/>
        <result property="studentNum" column="student_num"/>
        <result property="studentName" column="student_name"/>
        <result property="studentCollege" column="student_college"/>
        <result property="studentMajor" column="student_major"/>
        <result property="studentSex" column="student_sex"/>
        <result property="studentTel" column="student_tel"/>
        <result property="studentQq" column="student_qq"/>
        <result property="signStatus" column="sign_status"/>
        <result property="evaluationStatus" column="evaluation_status"/>
        <result property="evaluationValue" column="evaluation_value"/>
        <result property="evaluationContent" column="evaluation_content"/>
        <result property="createTime" column="create_time"/>
        <result property="createUser" column="create_user"/>
        <result property="updateTime" column="update_time"/>
        <result property="updateUser" column="update_user"/>
    </resultMap>

    <select id="selectSignCount" resultType="java.lang.Integer">
        select count(*)
        from ca_active_sign s left join ca_apply a
            on s.apply_id =  a.id
        where s.user_id = #{userId}
        <if test="activeApplySignQueryDTO.year != null">
            and a.year = #{activeApplySignQueryDTO.year}
        </if>
        <if test="activeApplySignQueryDTO.activeLevel != null">
            and a.active_level = #{activeApplySignQueryDTO.activeLevel}
        </if>
        <if test="activeApplySignQueryDTO.activeStatus != null">
            and a.active_status = #{activeApplySignQueryDTO.activeStatus}
        </if>
        <if test="activeApplySignQueryDTO.signStatus != null">
            and s.sign_status = #{activeApplySignQueryDTO.signStatus}
        </if>
        <if test="activeApplySignQueryDTO.evaluationStatus != null">
            and s.evaluation_status = #{activeApplySignQueryDTO.evaluationStatus}
        </if>
    </select>

    <select id="selectSignList" resultMap="activeSignMap">
        select s.*
        from ca_active_sign s left join ca_apply a
        on s.apply_id =  a.id
        where s.user_id = #{userId}
        <if test="activeApplySignQueryDTO.year != null">
            and a.year = #{activeApplySignQueryDTO.year}
        </if>
        <if test="activeApplySignQueryDTO.activeLevel != null">
            and a.active_level = #{activeApplySignQueryDTO.activeLevel}
        </if>
        <if test="activeApplySignQueryDTO.activeStatus != null">
            and a.active_status = #{activeApplySignQueryDTO.activeStatus}
        </if>
        <if test="activeApplySignQueryDTO.signStatus != null">
            and s.sign_status = #{activeApplySignQueryDTO.signStatus}
        </if>
        <if test="activeApplySignQueryDTO.evaluationStatus != null">
            and s.evaluation_status = #{activeApplySignQueryDTO.evaluationStatus}
        </if>
        ORDER BY
        CASE
            a.active_status
            WHEN '${@com.qingfeng.cms.domain.apply.enums.ActiveStatusEnum@COMPLETE.name}' THEN 1
            WHEN '${@com.qingfeng.cms.domain.apply.enums.ActiveStatusEnum@HAVING.name}' THEN 2
            WHEN '${@com.qingfeng.cms.domain.apply.enums.ActiveStatusEnum@INIT.name}' THEN 3
            ELSE 4
            END,
        s.create_time
        limit #{activeApplySignQueryDTO.pageNo}, #{activeApplySignQueryDTO.pageSize}
    </select>


    <select id="findUserSignActiveForFront"
            resultType="com.qingfeng.cms.domain.sign.vo.UserActiveSignFrontVo">
        select a.id,
               a.apply_user_id,
               a.active_name,
               a.active_level,
               a.active_principal,
               a.active_start_time,
               a.active_end_time,
               a.school_year,
               a.active_introduction,
               a.is_bonus_points_apply,
               a.active_score,
               a.active_status,
               s.sign_status
        from ca_active_sign s left join ca_apply a
                                        on s.apply_id =  a.id
        where s.user_id = #{userId}
        order by
        CASE
            a.agree_status
            WHEN '${@com.qingfeng.cms.domain.apply.enums.AgreeStatusEnum@IS_PASSED.name}' THEN 1
            WHEN '${@com.qingfeng.cms.domain.apply.enums.AgreeStatusEnum@INIT.name}' THEN 2
            ELSE 3
            END,
        CASE
            a.is_release
            WHEN '${@com.qingfeng.cms.domain.apply.enums.IsReleaseEnum@FINISH.name}' THEN 1
            ELSE 2
            END,
        CASE
            a.active_status
            WHEN '${@com.qingfeng.cms.domain.apply.enums.ActiveStatusEnum@HAVING.name}' THEN 1
            WHEN '${@com.qingfeng.cms.domain.apply.enums.ActiveStatusEnum@INIT.name}' THEN 2
            WHEN '${@com.qingfeng.cms.domain.apply.enums.ActiveStatusEnum@COMPLETE.name}' THEN 3
            ELSE 4
            END,
        CASE
            s.sign_status
            WHEN '${@com.qingfeng.cms.domain.sign.enums.SignStatusEnum@INIT.name}' THEN 1
            WHEN '${@com.qingfeng.cms.domain.sign.enums.SignStatusEnum@FINISH.name}' THEN 2
            ELSE 3
            END

    </select>


</mapper>